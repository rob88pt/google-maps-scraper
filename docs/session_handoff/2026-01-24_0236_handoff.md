# Session Handoff: Extra Reviews Feature Debugging

Read this file to continue debugging the extra reviews feature.

## Project Location
`D:\Websites\GMaps_scraper_gosom`

## Context Files to Read First
1. `source/FORK_CHANGELOG.md` - Documents all changes made to the Go scraper
2. `source/gmaps/reviews.go` - Core review extraction logic (lines 200-250)
3. `source/gmaps/place.go` - Where review extraction is triggered (lines 150-180)

## What Was Done This Session

### Configurable Review Count Implementation âœ…
- Changed `-extra-reviews` flag from bool to int across Go source
- Updated files: `runner.go`, `job.go`, `place.go`, `reviews.go`, `jobs.go`, `io.go`
- Updated webapp: `schemas.ts`, `docker.ts`, `job-form.tsx`, `types.ts`
- Added Reviews section to `lead-detail-panel.tsx`

### Bug Fixes Applied
1. **Fixed indentation** in `place.go` line 156
2. **Fixed nil map panic** in `reviews.go:extractPlaceID` - added `patterns = make(map[string]*regexp.Regexp)`
3. **Added debug logging** with `[ExtraReviews]` prefix

### Docker Image
Rebuilt multiple times. Current image has all fixes.

## Current Problem: Scraper Not Processing All Leads

### Symptoms
- User runs job with "mercearia lisboa" query
- Scraper finds 18 places
- Only 12 places get processed before job seems to "hang"
- Job eventually times out via `-exit-on-inactivity 3m`

### Evidence from Logs
```
2026-01-24 02:19:14.642 | "18 places found"
... (12 places processed with [ExtraReviews] logs)
2026-01-24 02:19:28.812 | job finished (last visible)
```
6 places are missing from the output.

### RPC Review Extraction IS Working
```
[ExtraReviews] ExtractExtraReviews=15, reviewCount=891
2026/01/24 02:19:19 RPC extraction successful: 1 review pages, ~20 reviews
[ExtraReviews] Got 1 RPC pages
```

### Hypothesis
With extra reviews enabled, each place takes 1-2 seconds longer. The scraper may be:
1. **Hanging** on review extraction for certain places (race condition?)
2. **Timing out** because total job time exceeds inactivity threshold
3. **Crashing silently** on specific place patterns

## How to Reproduce
1. Start the webapp: `cd leads-command-center && npm run dev`
2. Create new job with:
   - Query: "cafe coimbra" or "mercearia lisboa"
   - Extra Reviews: enabled, set to 100+
   - Depth: 1
3. Watch Docker logs: `docker logs -f lcc-job-XXXXXXXX`
4. Observe that not all places get processed

## Suggested First Actions

### Quick Test
Run a job with `extraReviews = 0` (disabled). If all 18 leads come through, confirms review extraction is causing the hang.

### Debug Further
Check `reviews.go` for potential:
- Infinite loops in RPC pagination
- Blocking operations without timeouts
- Race conditions in concurrent review fetching

### Key Code Paths
1. `place.go:BrowserActions()` calls `FetchReviewsWithFallback()`
2. `reviews.go:FetchReviewsWithFallback()` tries RPC then DOM
3. `reviews.go:fetcher.fetch()` does the actual RPC call
4. `reviews.go:extractReviewsFromPage()` does DOM extraction

## Dev Server
Running at `localhost:3000`

## Supabase Project
ID: `gokdallufzkbgzgzrhot`
