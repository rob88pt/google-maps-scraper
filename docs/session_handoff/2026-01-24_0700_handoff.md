# Session Handoff: Review Images Still Not Working

Read this file to continue debugging the missing review images issue.

## Project Location
`D:\Websites\GMaps_scraper_gosom`

## Context Files to Read First
1. `docs/active_context.md` - current state
2. `source/gmaps/reviews.go` - DOM extraction logic (lines 609-630)
3. `source/gmaps/entry.go` - RPC parsing logic (`parseReviews` function, line 461+)

## What Was Done This Session

### Discovery
- **RPC response** (`listugcposts`) does NOT contain actual photo URLs - it only has report links like `www.google.com/local/imagery/report/...`
- **DOM extraction** (fallback method) is the only path that CAN get real `lh3.googleusercontent.com` URLs
- User provided HTML showing photos are in `.Tya61d` buttons as `background-image` CSS, not `<img>` tags

### Changes Made
1. **`entry.go`** (line 273): Updated `extractReviews` to try new RPC path `[2][0][4]` for `listugcposts` response
2. **`entry.go`** (line 534): Updated `parseReviews` to try image at index `[6]` based on user-provided RPC analysis
3. **`reviews.go`** (line 618-625): Added code to extract `background-image` URLs from `.Tya61d` buttons

### Test Results
- Rebuilt Docker image with changes
- Ran test job for "Hideaway Coffee House London" with 10 extra reviews
- **Result**: Reviews still show `www.google.com/local/imagery/report/...` links instead of `lh3` URLs

## Why It Still Doesn't Work

### Hypothesis 1: DOM Extraction Not Being Used
The scraper may be successfully using RPC extraction (which returns bad links) and never falling back to DOM extraction. Check logs for:
- `"RPC extraction successful"` → RPC is being used (with bad data)
- `"DOM extraction successful"` → DOM fallback is being used

### Hypothesis 2: Wrong Review Container
The DOM extraction may not be finding the right parent element for reviews. The `.Tya61d` buttons need to be INSIDE the review element being iterated.

### Hypothesis 3: Reviews Already Parsed Before DOM
The `user_reviews` field is populated from `EntryFromJSON` (RPC data from the initial page load), while `user_reviews_extended` comes from scroll/fetch. Both may use the same flawed indices.

## Next Steps to Debug

### Step 1: Force DOM Extraction
Temporarily modify `reviews.go` around line 766 to skip RPC and force DOM:
```go
// In FetchReviewsWithFallback, comment out RPC and force DOM:
// rpcResponse, err := fetcher.fetch(ctx)
// ... skip to DOM extraction directly
```

### Step 2: Add Debug Logging
In `reviews.go` line 627, add logging:
```javascript
console.log('bgElements found:', bgElements.length);
console.log('Images extracted:', images);
```
Then check Docker logs for output.

### Step 3: Test DOM Extraction in Browser
Open a Google Maps place with review photos in Chrome DevTools and run:
```javascript
const bgElements = document.querySelectorAll('.Tya61d, button[style*="background-image"]');
for (const btn of bgElements) {
    const style = btn.getAttribute('style') || '';
    const match = style.match(/url\(["']?(https:\/\/lh3\.googleusercontent\.com[^"')]+)["']?\)/);
    if (match) console.log('Found:', match[1]);
}
```

### Step 4: Check Entry.go RPC Image Parsing
The inline `user_reviews` (not extended) also shows bad links. This comes from `EntryFromJSON` → `parseReviews`. The indices there may also be wrong: `el[2][2][0][1][21][7]` or `el[2][2][0][1][7]`.

## Key Files Modified
- `source/gmaps/entry.go` - RPC parsing
- `source/gmaps/reviews.go` - DOM extraction (line 618-625)

## Rebuild Command
```powershell
cd d:\Websites\GMaps_scraper_gosom
docker build -t google-maps-scraper:custom -f source\Dockerfile source
```

## Suggested First Action
Add debug logging to `reviews.go` DOM extraction to verify if `.Tya61d` buttons are being found at all, then check Docker logs during a job run.
