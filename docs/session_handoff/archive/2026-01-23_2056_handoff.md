# Session Handoff: Fix Leads API & UI Display

Read this file to continue where the previous session left off.

## Project Location
`D:\Websites\GMaps_scraper_gosom\leads-command-center`

## Context Files to Read First
1. `src/app/api/leads/route.ts` - **CRITICAL:** This endpoint is returning 500 Internal Server Error
2. `src/lib/docker.ts` - Verified working (scraper runs, processes JSON correctly)
3. `src/app/api/jobs/[id]/sync/route.ts` - Verified working (inserts leads into Supabase)

## Status Overview
- **Scraper:** ✅ WORkS. Runs, finishes, writes 1MB+ `results.json`.
- **Syncing:** ✅ WORKS. `POST /api/jobs/[id]/sync` successfully inserts leads into Supabase.
- **UI Display:** ❌ FAILS. The `/leads` page shows "Failed to fetch leads" because `/api/leads` returns 500.

## What Was Done This Session
1. **Defined New Workflow:** 
   - Removed `-dsn` flag (upsteam dependency issue).
   - Scraper now writes to local `results.json` volume.
   - App post-processes this JSON and inserts to Supabase.

2. **Verified End-to-End Flow:**
   - Created job "pizza milan" (ID: `5372e919...`).
   - Scraper completed successfully.
   - Triggered sync via console: `{ success: true, leadsInserted: 21 }`.
   - **Data IS in the database.**

3. **Identified Blocker:**
   - Browsing to `/leads` causes a 500 error.
   - Console logs: `GET /api/leads?page=1&pageSize=1 500 (Internal Server Error)`

## What To Do Next (Immediate Priority)
1. **Debug `/api/leads/route.ts`**:
   - The error is likely due to the `data` column being JSONB.
   - Or an issue with the Supabase client auth context in the GET route.
   - Check if the query is failing on the `user_id` mapping or RLS.

2. **Fix the UI**:
   - Once API is fixed, verify leads appear in the table.
   - Add a "Sync Leads" button to the Job details/list so users don't need to use the console.

## How to Verify
1. Start app: `npm run dev`
2. Open browser to `http://localhost:3000/leads`
3. If it loads without error and shows ~21 leads, you fixed it.
