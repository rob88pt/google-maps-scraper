# Session Handoff: Leads Command Center - Docker CP Fix + RLS Debugging

Read this file to continue where the previous session left off.

## Project Location
`D:\Websites\GMaps_scraper_gosom\leads-command-center`

## Context Files to Read First
1. `docs/active_context.md` - current state overview
2. `src/lib/docker.ts` - Docker cp implementation (FIXED)
3. `src/app/api/jobs/[id]/sync/route.ts` - Sync API with auth debugging

---

## What Was Done This Session

### 1. Fixed Docker CP Race Condition ✅
**Problem**: Scraper failed with `open /queries.txt: no such file or directory`
**Cause**: Container started before `docker cp` could copy the queries file
**Solution**: Changed from `docker run` → `docker create` + `docker cp` + `docker start`

Key code in `src/lib/docker.ts`:
```typescript
// Step 1: CREATE container (don't start)
const containerId = await createDockerContainer(dockerArgs) // uses 'create' not 'run'

// Step 2: Copy queries file BEFORE starting
await execAsync(`docker cp "${queriesPath}" ${containerName}:/queries.txt`)

// Step 3: START container now that file is in place
await execAsync(`docker start ${containerName}`)
```

**VERIFIED**: Scraper ran successfully, found 18 leads for "bakery Porto"

### 2. Fixed Results Extraction ✅
- `docker cp ${containerName}:/results.json` now extracts 207KB results file
- NDJSON parsing works correctly

### 3. Debugging RLS Insert Failure (IN PROGRESS)
**Problem**: Sync API processed 18 leads but inserted 0 into Supabase
**Initial Fix Attempt**: Used service role client to bypass RLS
**User Feedback**: This might indicate bad RLS policies, not a valid reason for service role

**Current State**: Added auth debugging to sync route:
```typescript
const { data: { user }, error: authError } = await supabase.auth.getUser()
console.log(`[Sync] Auth state - user: ${user?.id}, job.user_id: ${job.user_id}, match: ${user?.id === job.user_id}`)
```

### 4. Added CID Column ✅ (JUST APPLIED)
Created migration `006_add_cid_column.sql`:
- Adds `cid` column to `results` table
- Creates unique index on `(user_id, cid)` for deduplication
- User confirmed they applied this migration

---

## What's Left to Do

- [ ] **Test the sync again** - Create new job, wait for completion, call sync, check console logs for auth debug output
- [ ] **Fix RLS if needed** - Based on auth debug output, fix the INSERT policy if `auth.uid()` doesn't match
- [ ] **Re-enable `--rm` flag** - In `docker.ts` line ~164, uncomment `--rm` once everything works
- [ ] **Update active_context.md** with final status
- [ ] **Clean up old containers** - `docker rm -f $(docker ps -a --filter "name=lcc-job" -q)`

---

## Key Files Modified

| File                                         | Change                                                     |
| -------------------------------------------- | ---------------------------------------------------------- |
| `src/lib/docker.ts`                          | docker create/start pattern, buildDockerArgs uses 'create' |
| `src/lib/supabase/server.ts`                 | Added `createAdminClient()` (may not be needed)            |
| `src/app/api/jobs/[id]/sync/route.ts`        | Added auth debugging, restored cid column                  |
| `supabase/migrations/006_add_cid_column.sql` | NEW - adds cid column and unique index                     |

---

## RLS Policies to Check

The INSERT policy on `results` table:
```sql
CREATE POLICY "Users can create results"
    ON results FOR INSERT
    WITH CHECK (auth.uid() = user_id);
```

This requires the authenticated user's ID to match the `user_id` being inserted. The auth debug will show:
- If `user` is null → session not being passed to server
- If `user.id !== job.user_id` → mismatched users (shouldn't happen for own job)
- If they match → something else is wrong (column mismatch?)

---

## Commands to Verify Current State

```powershell
cd D:\Websites\GMaps_scraper_gosom\leads-command-center

# Check dev server
Get-Process node

# Clean up old containers
docker rm -f $(docker ps -a --filter "name=lcc-job" -q) 2>$null

# Check TypeScript compiles
npx tsc --noEmit
```

---

## How to Test

1. Navigate to http://localhost:3000/
2. Log in (important for RLS!)
3. Create a new job: "cafe Lisboa", depth 1
4. Wait for container to finish (`docker ps -a --filter "name=lcc-job"`)
5. Call sync API from browser console:
   ```javascript
   const res = await fetch('/api/jobs/<JOB_ID>/sync', { method: 'POST' });
   console.log(await res.json());
   ```
6. **Check Next.js terminal output** for `[Sync] Auth state` debug line
7. Based on output, fix RLS policy or auth handling

---

## Suggested First Action

Run a test job and capture the auth debug output from the sync API to determine why RLS insert is failing.

---

## Session Stats
- **Date**: 2026-01-23
- **Key Fixes**: Docker cp race condition resolved, cid column migration created
- **Remaining**: Debug RLS insert failure using auth logging
