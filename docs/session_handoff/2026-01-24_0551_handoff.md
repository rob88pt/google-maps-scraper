# Session Handoff: Extra Reviews Pipeline Debugging

Read this file to continue where the previous session left off. The "Extra Reviews" feature is still not working correctly in the UI despite backend fixes.

## Project Location
`d:\Websites\GMaps_scraper_gosom`

## Context Files to Read First
1. `docs/active_context.md` - Current state and known issues.
2. `source/gmaps/entry.go` - Check the `Review` struct (`json` tags added).
3. `leads-command-center/src/lib/docker.ts` - Check the `ScrapedLead` interface.
4. `leads-command-center/src/app/api/jobs/[id]/sync/route.ts` - Check the file-based logging and upsert logic.

## What Was Done This Session
- **Casing Fix**: Added `json:"..."` tags to the `Review` struct in Go to ensure lowercase keys in NDJSON. Rebuilt Docker image.
- **DB Constraint**: Added a `UNIQUE (user_id, cid)` constraint to the `results` table (requested user to do it manually).
- **Sync Logic**: Added detailed file-based logging to `sync_debug.log` to trace Supabase insertion errors.
- **Verification Job**: Ran `bakery porto` job. Scraper reported 300 reviews per lead. Sync reported 18 leads inserted.

## Current Status: BROKEN
- **Issue 1**: The Leads page only shows **one** bakery after the sync, despite 18 being "processed".
- **Issue 2**: The Side Panel for the visible lead **shows no reviews**, even though the scraper logs confirm they were extracted and attached.

## Key Decisions Made
- Using file-based logging (`sync_debug.log`) in the sync API because terminal output was occasionally truncated/inaccessible.
- Standard unique constraint instead of partial index to support PostgREST/Supabase `onConflict` logic.

## Gotchas / Watch Out For
- **Capitalization**: The Go scraper might still be producing capitalized keys if the Docker image didn't actually swap (unlikely but check `results.json`).
- **RLS**: The results might be inserted but hidden due to `user_id` mapping issues or RLS policies.
- **JSONB Pathing**: The UI (Side Panel) might be looking for `user_reviews_extended` but the data is nested differently or keys are still mismatched.

## How to Verify Current State
1. Check `leads-command-center/sync_debug.log` for the latest sync trace.
2. Open Supabase SQL Editor and run:
   ```sql
   SELECT id, (data->>'title'), (data->'user_reviews_extended') 
   FROM results WHERE job_id = '8e247652-91fa-4c76-bd92-06386200b4c7';
   ```
3. Check `leads-command-center/.jobs/8e2.../results.json` to see the raw NDJSON casing.

## Suggested First Action
Inspect the `results.json` from the latest job to verify the casing of the `user_reviews_extended` keys. If casing is correct, debug the `lead-detail-panel.tsx` to see why it's not rendering the data.
