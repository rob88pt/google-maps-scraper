# Session Handoff: Leads Command Center - Pipeline STABLE ✅

Read this file to continue where the previous session left off.

## Project Location
`D:\Websites\GMaps_scraper_gosom\leads-command-center`

## Context Files to Read First
1. `docs/active_context.md` - current state overview
2. `src/lib/docker.ts` - Fixed create/start/cp logic
3. `src/app/api/jobs/route.ts` - Fixed auto-sync and column names

---

## What Was Done This Session

### 1. Fixed Critical Pipeline Bugs ✅
- **Race Condition**: Removed `--rm` from Docker. Container now persists until `docker cp` extracts results, then cleaned up programmatically.
- **Column Mismatch**: Renamed `leads_found` to `result_count` globally.
- **Auto-Sync Logic**: Fixed race condition in `POST /api/jobs` where sync was attempted before query file was copied.

### 2. Verified Full E2E Pipeline ✅
- **Job**: "restaurant Braga" (depth 1) → **Status**: `completed` → **Leads**: 18.
- Database contains 54 leads across 3 verified test jobs.
- UI correctly shows "completed" status and lead counts.

### 3. RLS / Security ✅
- Confirmed `auth.uid() = user_id` policy is working correctly for inserts from the API.

---

## What's Left to Do (Next Steps)

### 1. Review Count Customization (Requested)
- [ ] Update `src/lib/schemas.ts` to include `maxReviews` (default 300).
- [ ] Update `src/components/jobs/job-form.tsx` to show a "Max Reviews" input *only* when "Extra Reviews" is enabled.
- [ ] Add warning: "Recommended ≤ 300 to avoid timeouts/crashes".
- [ ] Update `docker.ts` to pass `-max-reviews` flag to scraper if provided.

### 2. Map Implementation
- [ ] Replace placeholder in `/map` with MapLibre GL JS.
- [ ] Load leads from `results` table and render as markers.

### 3. UI Polish & Bug Fixes (Reported)
- [ ] **Config Presets**: Currently throwing an error on save. Needs investigation in `use-presets.ts` and `job-form.tsx`.
- [ ] **Filters**: Leads table filters are reported as not working.
- [ ] **Thumbnail Preview**: The larger image at the top of the right side panel (lead details) is not displaying correctly.
- [ ] **Page Size**: Implement configurable results-per-page on the leads page (Options: 25, 50, 100, 200; Default: 100).
- [ ] **Sync Button**: Add manual sync trigger for each job row.
- [ ] **Error Handling**: Improve UI feedback for job failures.

---

## Key Project IDs & Stats
- **Database**: 54 leads inserted successfully.
- **Latest Successful Job ID**: `1730b1f4-cb1a-4fca-94cc-18a1bbc87b53`
- **Scraper Image**: `google-maps-scraper:custom` (UTF-8 BOM fix included).

## Gotchas / Watch Out For
- **WSL2 Bind Mounts**: DO NOT USE. They are broken for Windows temp paths. Use `docker cp` for everything.
- **Column Names**: Database uses `result_count`. Do not use `leads_found`.

## Suggested First Action
Implement the `maxReviews` configuration in `src/components/jobs/job-form.tsx` and `src/lib/docker.ts`.
