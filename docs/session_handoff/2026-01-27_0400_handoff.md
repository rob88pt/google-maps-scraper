# Session Handoff: Map Restoration & CRM Enhancements

Read this file to continue where the previous session left off.

## Project Location
`d:\Websites\GMaps_scraper_gosom`

## Context Files to Read First
1. `docs/active_context.md` - Current state overview.
2. `docs/previous_chat_exports_archive/2026-01-27_0359_map_crm_restoration/2026-01-27_0400_implementation_plan.md` - The approved plan for execution.
3. `docs/task_list.md` - Tracks progress across sessions.

## What Was Done This Session
- **Comprehensive Research**: Analyzed the scraper source code (`source/gmaps/`), database schema (`results`, `jobs`, `lead_status`, `lead_notes`), and UI components (`map-base.tsx`, `lead-detail-panel.tsx`, `job-form.tsx`).
- **Discovered Source logic**: Found that the Go scraper *already* supports `query #!# id` in `jobs.go`, but it's not being used by the UI and existing data is using UUIDs for `input_id`.
- **Approved Implementation Plan**: Created a roadmap to restore map tiles, add image markers, implement CRM features (notes/status), and fix query mapping.
- **Media Asset Export**: Exported 8 verification screenshots and webp recordings to the session archive for visual reference of the current state.

## What's Left to Do (Next Session)
- [ ] **Phase 1: Map Restoration**
    - [ ] Update `map-base.tsx` with CartoDB tiles and thumbnail markers.
- [ ] **Phase 2: CRM Implementation**
    - [ ] Create API routes for notes and status updates.
    - [ ] Update `LeadDetailPanel` with CRM controls.
- [ ] **Phase 3: Scraper & Traceability**
    - [ ] Update `docker.ts` to use `#!#` for query mapping.
    - [ ] SQL migration to backfill `input_id` for existing records.
- [ ] **Phase 4: UI Quality of Life**
    - [ ] Add Nominatim coordinate picker to `job-form.tsx`.

## Key Decisions Made
- Reusing `LeadDetailPanel` for the Map side panel is already implemented but needs consistent CRM features added once.
- Using a separate `lead_status` and `lead_notes` table is for better data isolation and performance compared to bloating the `jsonb` data column.

## Suggested First Action
Start with **Phase 1**: Open `leads-command-center/src/components/ui/map-base.tsx` and implement the image markers and tile server fix.
