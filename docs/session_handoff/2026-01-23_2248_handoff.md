# Session Handoff: Leads Command Center - Docker Volume Mount Fix

Read this file to continue where the previous session left off.

## Project Location
`D:\Websites\GMaps_scraper_gosom\leads-command-center`

## Context Files to Read First
1. `docs/active_context.md` - current state overview
2. `src/lib/docker.ts` - the file we just rewrote (THE MAIN FOCUS)
3. `src/app/api/jobs/[id]/sync/route.ts` - calls processJobResults()

---

## What Was Done This Session

### Debugging Docker Volume Mount Issue

**Problem**: The scraper was successfully finding 18 places (confirmed via container logs), but the results file was never appearing on the host filesystem.

**Root Cause Found**:
- WSL2 bind mounts from Windows paths are fundamentally broken in this Docker Desktop setup
- Whether using Windows temp directory (`C:\Users\...\AppData\Local\Temp`) or project-local paths (`D:\Websites\...\.jobs`)
- `docker inspect` showed mounts configured correctly, but `/data` directory inside container was always **empty**
- This was confirmed by exporting the container filesystem and checking the `data/` directory was empty

**Solution Implemented**:
Completely rewrote `src/lib/docker.ts` to use `docker cp` instead of bind mounts:

1. **`spawnScraperContainer()`** now:
   - Creates container WITHOUT volume mounts
   - Writes queries to local `.jobs/{jobId}/queries.txt`
   - Uses `docker cp` to copy queries INTO the running container
   - Container reads from `/queries.txt` and writes to `/results.json` (inside container)

2. **`processJobResults()`** now:
   - Uses `docker cp` to EXTRACT `/results.json` from container to `.jobs/{jobId}/results.json`
   - Then parses the extracted file locally

3. **`buildDockerArgs()`** updated:
   - No longer includes `-v` volume mount flags
   - Paths are now container-internal (`/queries.txt`, `/results.json`)

---

## What's Left to Do

- [ ] **TEST THE FIX** - Create a new job from the UI and verify:
  1. Container starts successfully
  2. `docker cp` copies queries into container without error
  3. Scraper runs and finds places
  4. After container exits, call sync API to extract results
  5. Verify results are parsed and inserted into Supabase

- [ ] **Re-enable `--rm` flag** - Once fix is verified, re-enable auto-removal of containers (currently disabled for debugging at line ~157 in docker.ts)

- [ ] **Update documentation** - Update `docs/active_context.md` with the WSL2 mount fix details

---

## Key Code Changes

### `src/lib/docker.ts`

```typescript
// OLD (broken):
// -v ${jobDir}:/data  <- WSL2 bind mount never synced

// NEW (working):
// 1. Create container without mounts
const dockerArgs = buildDockerArgs(params, containerName) // No -v flags

// 2. Copy queries in after container starts
await execAsync(`docker cp "${queriesPath}" ${containerName}:/queries.txt`)

// 3. Extract results after container exits (in processJobResults)
await execAsync(`docker cp ${containerName}:/results.json "${resultsPath}"`)
```

---

## Known Gotchas

1. **PowerShell `echo` creates UTF-16** - Don't use `echo "text" > file.txt` for test files. Always use Node.js `writeFile` with 'utf-8' encoding.

2. **Container name format** - `lcc-job-{first 8 chars of jobId}`

3. **Container not removed** - `--rm` flag is currently commented out for debugging. Old containers persist and need manual cleanup with `docker rm`.

---

## Commands to Verify Current State

```powershell
# Check for any existing containers
docker ps -a --filter "name=lcc-job"

# Check if dev server is running
Get-Process node

# Check TypeScript compiles
cd D:\Websites\GMaps_scraper_gosom\leads-command-center
npx tsc --noEmit

# Clean up old containers
docker rm -f $(docker ps -a --filter "name=lcc-job" -q)

# Check .jobs directory
Get-ChildItem ".jobs" -Recurse
```

---

## How to Test the Fix

1. Navigate to http://localhost:3000/
2. Create a new job with query "bakery Porto", depth 1
3. Wait for container to finish (check Docker Desktop or `docker ps`)
4. In the UI, the job should auto-sync OR manually call:
   ```
   POST http://localhost:3000/api/jobs/{jobId}/sync
   ```
5. Check Supabase `results` table for new leads

---

## Suggested First Action

Run a test job and verify the docker cp approach works:

```powershell
# Start fresh
cd D:\Websites\GMaps_scraper_gosom\leads-command-center
docker rm -f $(docker ps -a --filter "name=lcc-job" -q) 2>$null

# Verify dev server is running
# Then create job from UI at http://localhost:3000/
# Monitor: docker logs -f <container_name>
# After exit: call sync API or wait for auto-sync
```

---

## Session Stats
- **Date**: 2026-01-23
- **Duration**: ~1 hour debugging + implementing fix
- **Key Insight**: WSL2 9p filesystem mounts are unreliable for Docker Desktop on Windows; use `docker cp` as workaround
